#!/bin/bash
# claude-symphony-play - Main entry point for Memory Relay orchestration
# Part of claude-symphony package
# Usage: claude-symphony-play [command] [options]

set -euo pipefail

# Determine base directory (supports both package and global installation)
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Configuration - prefer project-local, fallback to global
if [[ -f "${SCRIPT_DIR}/../config.json" ]]; then
    RELAY_BASE="$(dirname "${SCRIPT_DIR}")"
else
    RELAY_BASE="${HOME}/.claude/memory-relay"
fi

ORCHESTRATOR_DIR="${RELAY_BASE}/orchestrator"
LOG_DIR="${RELAY_BASE}/logs"
VERSION="1.0.0"
SESSION_NAME="symphony-session"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
MAGENTA='\033[0;35m'
NC='\033[0m'

# Show help
show_help() {
    cat << 'EOF'
+====================================================================+
|        Claude Symphony - Memory Relay Context Manager              |
+====================================================================+
|                                                                    |
|  Automatically manages Claude session handoffs when context        |
|  reaches 50%, ensuring seamless continuity of work.                |
|                                                                    |
+====================================================================+

USAGE:
    claude-symphony-play [COMMAND] [OPTIONS]

COMMANDS:
    (none)          Start Claude with relay orchestration (default)
    start           Same as above
    status          Show Context Manager status
    logs            View relay logs
    stop            Stop the Context Manager
    cleanup         Clean up stale FIFO and PID files
    help            Show this help message

OPTIONS:
    -d, --directory DIR    Start in specified directory
    -v, --verbose          Enable verbose output
    --version              Show version

EXAMPLES:
    claude-symphony-play                    # Start orchestrated session
    claude-symphony-play -d ~/my-project    # Start in specific directory
    claude-symphony-play status             # Check if orchestrator is running
    claude-symphony-play logs               # View recent logs
    claude-symphony-play logs -f            # Follow logs (tail -f)

HOW IT WORKS:
    1. Starts a tmux session with Claude and the orchestrator
    2. When Claude detects 50% context usage, it creates HANDOFF.md
    3. Claude signals the orchestrator via FIFO
    4. Orchestrator starts a new Claude session with the handoff
    5. Old session receives ACK and can safely exit

SIGNAL FLOW:
    Claude (old) --> RELAY_READY --> Orchestrator --> Claude (new)
                 <-- RELAY_ACK <--

For more info, see the README at:
    ~/.claude/memory-relay/README.md
    or
    <claude-symphony>/scripts/memory-relay/README.md

EOF
}

# Show version
show_version() {
    echo "claude-symphony-play version ${VERSION}"
    echo "Part of claude-symphony package"
}

# Show status
show_status() {
    echo -e "${CYAN}Claude Symphony - Memory Relay Status${NC}"
    echo "======================================"
    echo ""
    echo -e "Relay Base: ${BLUE}${RELAY_BASE}${NC}"
    echo ""

    # Orchestrator status
    local pid_file="${ORCHESTRATOR_DIR}/orchestrator.pid"
    if [[ -f "${pid_file}" ]]; then
        local pid=$(cat "${pid_file}")
        if kill -0 "${pid}" 2>/dev/null; then
            echo -e "Context Manager: ${GREEN}Running${NC} (PID: ${pid})"
        else
            echo -e "Context Manager: ${RED}Stopped${NC} (stale PID file)"
        fi
    else
        echo -e "Context Manager: ${YELLOW}Not running${NC}"
    fi

    # FIFO status
    local fifo_path="${ORCHESTRATOR_DIR}/signals/relay.fifo"
    if [[ -p "${fifo_path}" ]]; then
        echo -e "FIFO:         ${GREEN}Ready${NC}"
    else
        echo -e "FIFO:         ${YELLOW}Not created${NC}"
    fi

    # tmux session status
    if tmux has-session -t "${SESSION_NAME}" 2>/dev/null; then
        echo -e "tmux Session: ${GREEN}Active${NC} (${SESSION_NAME})"
        echo ""
        echo "Panes:"
        tmux list-panes -t "${SESSION_NAME}" -F "  #{pane_index}: #{pane_title} (#{pane_current_command})" 2>/dev/null || true
    else
        echo -e "tmux Session: ${YELLOW}Not active${NC}"
    fi

    echo ""
    echo "Recent activity:"
    if [[ -f "${LOG_DIR}/orchestrator.log" ]]; then
        tail -3 "${LOG_DIR}/orchestrator.log" | sed 's/^/  /'
    else
        echo "  (no logs)"
    fi
}

# View logs
view_logs() {
    local follow=false
    local log_file="${LOG_DIR}/orchestrator.log"

    while [[ $# -gt 0 ]]; do
        case "$1" in
            -f|--follow) follow=true; shift ;;
            *) shift ;;
        esac
    done

    if [[ ! -f "${log_file}" ]]; then
        echo "No logs found at ${log_file}"
        echo "Start a session first with: claude-symphony-play"
        exit 1
    fi

    if ${follow}; then
        echo -e "${BLUE}Following logs (Ctrl+C to stop)...${NC}"
        tail -f "${log_file}"
    else
        echo -e "${BLUE}Recent logs:${NC}"
        tail -50 "${log_file}"
    fi
}

# Stop orchestrator
stop_orchestrator() {
    "${ORCHESTRATOR_DIR}/orchestrator.sh" stop
}

# Cleanup stale files
cleanup() {
    echo -e "${BLUE}Cleaning up Memory Relay files...${NC}"

    local pid_file="${ORCHESTRATOR_DIR}/orchestrator.pid"
    local fifo_path="${ORCHESTRATOR_DIR}/signals/relay.fifo"

    if [[ -f "${pid_file}" ]]; then
        local pid=$(cat "${pid_file}")
        if ! kill -0 "${pid}" 2>/dev/null; then
            rm -f "${pid_file}"
            echo "  Removed stale PID file"
        fi
    fi

    if [[ -p "${fifo_path}" ]]; then
        # Check if anyone is reading from FIFO
        if ! lsof "${fifo_path}" &>/dev/null; then
            rm -f "${fifo_path}"
            echo "  Removed unused FIFO"
        else
            echo "  FIFO is in use, not removing"
        fi
    fi

    echo -e "${GREEN}Cleanup complete${NC}"
}

# Start orchestrated session
start_session() {
    local work_dir="$(pwd)"

    while [[ $# -gt 0 ]]; do
        case "$1" in
            -d|--directory)
                work_dir="$2"
                shift 2
                ;;
            *)
                shift
                ;;
        esac
    done

    # Validate directory
    if [[ ! -d "${work_dir}" ]]; then
        echo -e "${RED}Error: Directory not found: ${work_dir}${NC}"
        exit 1
    fi

    # Start tmux session
    exec "${ORCHESTRATOR_DIR}/tmux-startup.sh" "${work_dir}"
}

# Main
main() {
    # Ensure directories exist
    mkdir -p "${LOG_DIR}"
    mkdir -p "${ORCHESTRATOR_DIR}/signals"

    # Make scripts executable
    chmod +x "${ORCHESTRATOR_DIR}/orchestrator.sh" 2>/dev/null || true
    chmod +x "${ORCHESTRATOR_DIR}/claude-wrapper.sh" 2>/dev/null || true
    chmod +x "${ORCHESTRATOR_DIR}/tmux-startup.sh" 2>/dev/null || true

    local command="${1:-start}"

    case "${command}" in
        start|"")
            shift 2>/dev/null || true
            start_session "$@"
            ;;
        status)
            show_status
            ;;
        logs)
            shift
            view_logs "$@"
            ;;
        stop)
            stop_orchestrator
            ;;
        cleanup)
            cleanup
            ;;
        help|--help|-h)
            show_help
            ;;
        --version)
            show_version
            ;;
        *)
            echo -e "${RED}Unknown command: ${command}${NC}"
            echo "Run 'claude-symphony-play help' for usage"
            exit 1
            ;;
    esac
}

main "$@"
